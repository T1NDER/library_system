{% extends 'base.html' %}

{% load static %}

{% block title %}Каталог книг{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Каталог книг</h1>
    <div class="search-form">
        <form method="get" class="filter-form">
            <div class="form-inline">
                <div class="form-group">
                    <label for="search">Поиск по книгам</label>
                    <input type="text" id="search" name="query" placeholder="Название, автор, жанр..." 
                           value="{{ request.GET.query }}" class="search-input">
                </div>
                
                <div class="form-group">
                    <label for="genre">Жанр</label>
                    <select id="genre" name="genre" class="filter-select">
                        <option value="">Все жанры</option>
                        {% for genre in genres %}
                            <option value="{{ genre.id }}" 
                                {% if request.GET.genre == genre.id|stringformat:"i" %}selected{% endif %}>
                                {{ genre.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            
                <div class="form-group form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Найти
                    </button>
                    <a href="{% url 'books:book_list' %}" class="btn btn-secondary">
                        <i class="fas fa-undo"></i> Сбросить
                    </a>
                    {% if user.is_authenticated and user.role == 'librarian' or user.role == 'admin' %}
                        <a href="{% url 'books:add_book' %}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Добавить книгу
                        </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <div class="results-info">
        <p class="results-count">Найдено книг: <strong>{{ page_obj.paginator.count }}</strong></p>
        
        {% if request.GET.query or request.GET.genre %}
            <div class="active-filters">
                <strong>Активные фильтры:</strong>
                <div class="filter-tags">
                    {% if request.GET.query %}
                        <span class="filter-tag">
                            Поиск: "{{ request.GET.query }}"
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'query' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}" 
                               class="remove-filter">×</a>
                        </span>
                    {% endif %}
                    
                    {% if request.GET.genre %}
                        {% for genre in genres %}
                            {% if request.GET.genre == genre.id|stringformat:"i" %}
                                <span class="filter-tag">
                                    Жанр: {{ genre.name }}
                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'genre' %}{{ key }}={{ value }}{% if not forloop.last %}&{% endif %}{% endif %}{% endfor %}" 
                                       class="remove-filter">×</a>
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="books-grid">
        {% for book in page_obj %}
            <div class="book-card">
                <div class="book-header">
                    <h3><a href="{% url 'books:book_detail' book.id %}">{{ book.title }}</a></h3>
                    {% if book.is_available %}
                        <span class="status available">
                            <i class="fas fa-check-circle"></i> Доступна
                        </span>
                    {% else %}
                        <span class="status unavailable">
                            <i class="fas fa-times-circle"></i> Нет в наличии
                        </span>
                    {% endif %}
                </div>
                
                <div class="book-info">
                    <p class="book-author">
                        <i class="fas fa-user-pen"></i>
                        <strong>Автор:</strong> {{ book.author.name }}
                    </p>
                    
                    {% if book.genre %}
                    <p class="book-genre">
                        <i class="fas fa-tag"></i>
                        <strong>Жанр:</strong> {{ book.genre.name }}
                    </p>
                    {% endif %}
                    
                    <p class="book-copies">
                        <i class="fas fa-copy"></i>
                        <strong>Доступно:</strong> 
                        <span class="copies-count">
                            {{ book.available_copies }} из {{ book.total_copies }}
                        </span>
                    </p>
                    
                    {% if book.publication_year %}
                    <p class="book-year">
                        <i class="fas fa-calendar"></i>
                        <strong>Год издания:</strong> {{ book.publication_year }}
                    </p>
                    {% endif %}
                </div>
                
                {% if book.description %}
                <div class="book-description">
                    <p>{{ book.description|truncatewords:30 }}</p>
                </div>
                {% endif %}
                
                <div class="book-actions">
                    <a href="{% url 'books:book_detail' book.id %}" class="btn btn-outline">
                        <i class="fas fa-eye"></i> Подробнее
                    </a>
                    {% if book.is_available %}
                        {% if user.is_authenticated %}
                            {% if user.role == 'librarian' or user.role == 'admin' %}
                                <a href="{% url 'borrowings:borrow_form' %}?book={{ book.id }}" class="btn btn-primary">
                                    <i class="fas fa-book"></i> Выдать книгу
                                </a>
                            {% else %}
                                <!-- Кнопка взять книгу убрана для читателя -->
                            {% endif %}
                        {% else %}
                            <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i> Войти
                            </a>
                        {% endif %}
                    {% else %}
                        <span class="btn btn-disabled" style="cursor: not-allowed; opacity: 0.7;">
                            <i class="fas fa-clock"></i> Недоступно
                        </span>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <div class="no-books-found">
                <div class="no-books-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3>Книги не найдены</h3>
                <p>Попробуйте изменить параметры поиска или сбросить фильтры</p>
                <a href="{% url 'books:book_list' %}" class="btn btn-primary">
                    <i class="fas fa-list"></i> Показать все книги
                </a>
            </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-arrow">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="pagination-current">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="pagination-number">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-arrow">
                    <i class="fas fa-chevron-right"></i>
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const borrowButtons = document.querySelectorAll('.borrow-btn');

    borrowButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            const bookTitle = this.getAttribute('data-title');
            const confirmed = confirm('Вы уверены, что хотите взять книгу "' + bookTitle + '"?');

            if (!confirmed) {
                event.preventDefault();
            }
        });
    });

    const userRole = document.body.getAttribute('data-user-role');
    if (userRole === 'reader') {
        const borrowLibrarianButtons = document.querySelectorAll('a[href*="borrow_form"]');

        borrowLibrarianButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                alert('Недостаточно прав доступа. Только библиотекари могут выдавать книги.');
            });
        });
    }
});
</script>
{% endblock %}